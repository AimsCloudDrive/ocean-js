<!DOCTYPE html>
<html>
  <head>
    <title>Component Preview</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container">
      <div id="file-tree"></div>
      <div id="preview">
        <iframe id="frame"></iframe>
      </div>
    </div>

    <script type="module">
      async function init() {
        // è·å–ç›®å½•ç»“æ„
        const response = await fetch("/api/tree");
        const treeData = await response.json();

        // æ¸²æŸ“æ–‡ä»¶æ ‘
        renderTree(treeData, document.getElementById("file-tree"));
      }

      function renderTree(node, container) {
        const ul = document.createElement("ul");

        node.children?.forEach((child) => {
          const li = document.createElement("li");

          if (child.children) {
            // ç›®å½•èŠ‚ç‚¹
            li.innerHTML = `<span class="folder">ğŸ“ ${child.name}</span>`;
            renderTree(child, li);
          } else {
            // æ–‡ä»¶èŠ‚ç‚¹
            li.innerHTML = `<span class="file">ğŸ“„ ${child.name}</span>`;
            li.addEventListener("click", () => loadPreview(child.path));
          }

          ul.appendChild(li);
        });

        container.appendChild(ul);
      }

      async function loadPreview(filePath) {
        const frame = document.getElementById("frame");

        // ç”Ÿæˆå®‰å…¨æ²™ç®±
        const sandbox = document.createElement("iframe");
        sandbox.sandbox = "allow-scripts allow-same-origin";
        sandbox.style = "width:100%;height:100%;border:none";

        // åŠ è½½æ„å»ºç»“æœ
        const bundleUrl = `/api/bundle?path=${encodeURIComponent(filePath)}`;
        sandbox.srcdoc = `
      <!DOCTYPE html>
      <html>
        <head>
          <script src="https://unpkg/react@18/umd/react.development.js"><\/script>
          <script src="https://unpkg/react-dom@18/umd/react-dom.development.js"><\/script>
        </head>
        <body>
          <div id="root"></div>
          <script type="module">
            try {
              import('${bundleUrl}')
                .then(module => {
                  if (module.default) {
                    ReactDOM.render(
                      React.createElement(module.default),
                      document.getElementById('root')
                    );
                  }
                });
            } catch (e) {
              console.error(e);
              document.body.innerHTML = \`<pre style="color:red">\${e}</pre>\`;
            }
          <\/script>
        </body>
      </html>
    `;

        frame.replaceWith(sandbox);
      }

      init();
    </script>
  </body>
</html>
